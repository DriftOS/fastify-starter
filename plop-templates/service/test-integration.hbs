import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { buildApp } from '../../../app.js';
import type { FastifyInstance } from 'fastify';

/**
 * Integration tests for {{pascalCase name}} service
 * 
 * Tests the complete request flow through the API.
 * 
 * Generated by: npm run generate
 */
describe('{{pascalCase name}} Integration Tests', () => {
  let app: FastifyInstance;
  let authToken: string;

  beforeAll(async () => {
    // Build the app
    app = await buildApp();

    // TODO: Create a test user and get auth token
    // For now, you'll need to implement authentication or mock it
    authToken = 'test-token';
  });

  afterAll(async () => {
    await app.close();
  });

  describe('POST /api/v1/{{kebabCase name}}s', () => {
    it('should create a {{camelCase name}} successfully', async () => {
      const response = await app.inject({
        method: 'POST',
        url: '/api/v1/{{kebabCase name}}s',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
        payload: {
          // TODO: Add valid test data
          name: 'Test {{pascalCase name}}',
        },
      });

      expect(response.statusCode).toBe(201);
      
      const body = JSON.parse(response.body);
      expect(body.success).toBe(true);
      expect(body.data).toBeDefined();
      expect(body.data.id).toBeDefined();
      expect(body.metadata).toBeDefined();
      expect(body.metadata.duration).toBeGreaterThan(0);
      expect(body.metadata.metrics).toBeDefined();
      
      // Verify performance metrics are included
      {{#each operations}}
      expect(body.metadata.metrics['{{kebabCase this}}']).toBeGreaterThanOrEqual(0);
      {{/each}}
    });

    it('should return 400 for invalid input', async () => {
      const response = await app.inject({
        method: 'POST',
        url: '/api/v1/{{kebabCase name}}s',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
        payload: {
          // TODO: Add invalid test data
          name: '',
        },
      });

      expect(response.statusCode).toBe(400);
      
      const body = JSON.parse(response.body);
      expect(body.success).toBe(false);
      expect(body.error).toBeDefined();
      expect(body.error.message).toBeDefined();
    });

    it('should return 401 without authentication', async () => {
      const response = await app.inject({
        method: 'POST',
        url: '/api/v1/{{kebabCase name}}s',
        payload: {
          name: 'Test',
        },
      });

      expect(response.statusCode).toBe(401);
    });

    it('should respect rate limiting', async () => {
      // TODO: Test rate limiting if configured
      // Make multiple requests and verify 429 response
    });
  });

  describe('GET /api/v1/{{kebabCase name}}s/health', () => {
    it('should return healthy status', async () => {
      const response = await app.inject({
        method: 'GET',
        url: '/api/v1/{{kebabCase name}}s/health',
      });

      expect(response.statusCode).toBe(200);
      
      const body = JSON.parse(response.body);
      expect(body.status).toBe('healthy');
      expect(body.service).toBe('{{pascalCase name}}Service');
    });
  });

  describe('GET /api/v1/{{kebabCase name}}s', () => {
    it('should list {{camelCase name}}s', async () => {
      const response = await app.inject({
        method: 'GET',
        url: '/api/v1/{{kebabCase name}}s',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(200);
      
      const body = JSON.parse(response.body);
      expect(body.success).toBe(true);
      expect(body.data).toBeInstanceOf(Array);
    });
  });
});
